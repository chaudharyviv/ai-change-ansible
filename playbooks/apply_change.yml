---
# =============================================================
# apply_change.yml
# Runs ON: Oracle VM (managed node)
# Triggered BY: GitHub Actions runner
# Extra vars: scenario, change_number
# Output: /tmp/change_applied.json
# =============================================================

- name: Apply Change Scenario
  hosts: managed
  gather_facts: yes

  vars:
    scenario: "small_disk"
    change_number: "UNKNOWN"
    temp_small: /tmp/ai_small.bin
    temp_large: /tmp/ai_large.bin
    output_file: /tmp/change_applied.json

  tasks:

    - name: Validate scenario
      fail:
        msg: "Invalid scenario '{{ scenario }}'. Use: small_disk | large_disk | cpu_stress | stop_service"
      when: scenario not in ['small_disk', 'large_disk', 'cpu_stress', 'stop_service']

    # ── small_disk: 50MB write → PASS ──────────────────────────
    - name: "[small_disk] Write 50MB to /tmp"
      command: dd if=/dev/zero of={{ temp_small }} bs=1M count=50 status=none
      when: scenario == "small_disk"
      changed_when: true

    # ── large_disk: 2GB write → FAIL ───────────────────────────
    - name: "[large_disk] Write 2GB to /tmp"
      command: dd if=/dev/zero of={{ temp_large }} bs=1M count=2000 status=none
      when: scenario == "large_disk"
      changed_when: true
      async: 300
      poll: 10

    # ── cpu_stress: 4 yes processes → FAIL ─────────────────────
    - name: "[cpu_stress] Spawn stress processes"
      shell: nohup yes > /dev/null 2>&1 & echo $!
      when: scenario == "cpu_stress"
      loop: [1, 2, 3, 4]
      register: cpu_pids
      changed_when: true

    - name: "[cpu_stress] Save PIDs"
      copy:
        dest: /tmp/stress_pids.txt
        content: "{{ cpu_pids.results | map(attribute='stdout') | join('\n') }}\n"
      when: scenario == "cpu_stress"

    - name: "[cpu_stress] Wait for load to build"
      pause:
        seconds: 5
      when: scenario == "cpu_stress"

    # ── stop_service: stop chronyd → FAIL ──────────────────────
    - name: "[stop_service] Stop chronyd"
      systemd:
        name: chronyd
        state: stopped
      become: yes
      when: scenario == "stop_service"
      changed_when: true

    # ── Capture immediate state ─────────────────────────────────
    - name: Root disk percent post-change
      shell: df / | tail -1 | awk '{print $5}' | tr -d '%'
      register: post_root_pct
      changed_when: false

    - name: /tmp percent post-change
      shell: df /tmp | tail -1 | awk '{print $5}' | tr -d '%'
      register: post_tmp_pct
      changed_when: false

    - name: Load post-change
      shell: cat /proc/loadavg | awk '{print $1}'
      register: post_load
      changed_when: false

    - name: Write change_applied.json
      copy:
        dest: "{{ output_file }}"
        content: "{{ result | to_nice_json }}"
      vars:
        result:
          scenario: "{{ scenario }}"
          change_number: "{{ change_number }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"
          hostname: "{{ ansible_hostname }}"
          expected_verdict: "{{ 'PASS' if scenario == 'small_disk' else 'FAIL' }}"
          immediate_root_pct: "{{ post_root_pct.stdout | int }}"
          immediate_tmp_pct: "{{ post_tmp_pct.stdout | int }}"
          immediate_load_1m: "{{ post_load.stdout | float }}"

    - name: Print summary
      debug:
        msg:
          - "=== CHANGE APPLIED ==="
          - "Scenario  : {{ scenario }}"
          - "Expected  : {{ 'PASS' if scenario == 'small_disk' else 'FAIL' }}"
          - "Root Disk : {{ post_root_pct.stdout }}%"
          - "/tmp      : {{ post_tmp_pct.stdout }}%"
          - "Load(1m)  : {{ post_load.stdout }}"
