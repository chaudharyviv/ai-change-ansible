name: post_health_check

on:
  workflow_dispatch:
    inputs:
      change_number:
        description: "ServiceNow Change Number"
        required: true

jobs:
  post_health:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout playbooks
        uses: actions/checkout@v4

      - name: Install Ansible
        run: pip install ansible

      - name: Write SSH private key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_PRIVATE_KEY }}" > ~/.ssh/oracle.pem
          chmod 600 ~/.ssh/oracle.pem
          ssh-keyscan -H ${{ secrets.ORACLE_VM_HOST }} >> ~/.ssh/known_hosts

      - name: Write Ansible inventory
        run: |
          cat > /tmp/inventory.ini << EOF
          [managed]
          oracle-vm ansible_host=${{ secrets.ORACLE_VM_HOST }} \
                    ansible_user=${{ secrets.ORACLE_VM_USER }} \
                    ansible_ssh_private_key_file=~/.ssh/oracle.pem \
                    ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      - name: Run post_health_check.yml
        run: |
          ansible-playbook playbooks/post_health_check.yml \
            -i /tmp/inventory.ini \
            -e "change_number=${{ github.event.inputs.change_number }}"

      - name: Fetch post_health.json from Oracle VM
        run: |
          scp -i ~/.ssh/oracle.pem \
              -o StrictHostKeyChecking=no \
              ${{ secrets.ORACLE_VM_USER }}@${{ secrets.ORACLE_VM_HOST }}:/tmp/post_health.json \
              ./post_health.json
          cat post_health.json | python3 -m json.tool | head -40

      - name: Upload post_health.json as artifact
        uses: actions/upload-artifact@v4
        with:
          name: post_health
          path: post_health.json
          retention-days: 1
